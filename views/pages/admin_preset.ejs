<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  </head>
  <body>
    <div class="navbar py-4 bg-dark text-white">
      <div class="container">
        <a href="/admin" target="_blank"
          ><%= mapName %> Preset - Urbanescapes</a
        >
      </div>
    </div>
    <div class="mt-5 text-light">
      <div class="container">
        <div id="g-map"></div>
        <div class="navigation mt-3">
          <button class="btn btn-primary cenpo" style="display: none">
            Set Center Point
          </button>
          <button class="btn btn-info roupo" style="display: none">
            Save Preset
          </button>
        </div>
      </div>
    </div>
    <style>
      #g-map {
        height: 80vh;
      }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?libraries=marker&key=<%= apiKey %>"></script>
    <script>
      const url = window.location.pathname.split("/");
      const mapId = url[url.length - 1];
      navigator.geolocation.getCurrentPosition(
        (position) => {
          function getDistanceAndAngle(lat2, lon2) {
            const lat1 = centerMarker.position.lat;
            const lon1 = centerMarker.position.lng;
            const R = 6371000;
            const toRad = (angle) => (angle * Math.PI) / 180;
            const toDeg = (rad) => (rad * 180) / Math.PI;

            const φ1 = toRad(lat1);
            const φ2 = toRad(lat2);
            const Δφ = toRad(lat2 - lat1);
            const Δλ = toRad(lon2 - lon1);

            const a =
              Math.sin(Δφ / 2) ** 2 +
              Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) ** 2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c;

            const y = Math.sin(Δλ) * Math.cos(φ2);
            const x =
              Math.cos(φ1) * Math.sin(φ2) -
              Math.sin(φ1) * Math.cos(φ2) * Math.cos(Δλ);
            const θ = Math.atan2(y, x);
            const angle = (toDeg(θ) + 360) % 360;

            return { distance, angle };
          }
          let centerMarker, coordsMarker, pathUI;
          const path = [];
          const tmPath = [];
          let centerMode = true;
          const pos = {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
          };

          const map = new google.maps.Map(document.getElementById("g-map"), {
            zoom: 15,
            center: pos,
            mapId: "Main_Map",
          });
          centerMarker = new google.maps.marker.AdvancedMarkerElement({
            position: pos,
          });
          pathUI = new google.maps.Polyline();
          google.maps.event.addListener(map, "click", function (event) {
            if (centerMode) {
              centerMarker.position = event.latLng;
              console.log(centerMarker.position);
              centerMarker.setMap(map);
              $("button.cenpo").show();
            } else {
              const newPos = {
                lat: event.latLng.lat(),
                lng: event.latLng.lng(),
              };
              tmPath.push(newPos);
              path.push(getDistanceAndAngle(newPos.lat, newPos.lng));
              if (path.length == 3) {
                $(".roupo").show();
              }
              pathUI.setPath([...tmPath, tmPath[0]]);
              pathUI.setMap(map);
            }
          });

          $(document).ready(function () {
            $(".navigation button").click(function () {
              if ($(this).hasClass("cenpo")) {
                $(this).hide();
                centerMode = false;
              }
            });
            $(".roupo").click(function () {
              $(this).attr("disabled", true);
              $(this).text("Loading........");
              $.post(
                `/admin/preset/${mapId}`,
                { path: JSON.stringify(path) },
                (d) => {
                  if (d.status == "success") {
                    alert("Preset saved successfully");
                  }
                }
              );
              $(this).text("Save Preset");
              $(this).attr("disabled", false);
            });
          });
        },
        () => {
          alert("Failed to get your location.");
        }
      );
    </script>
  </body>
</html>
